<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Membership Card</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple animation for UI elements */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Loading spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-md p-6 mx-auto my-8 bg-white rounded-2xl shadow-lg text-center">
        <!-- Header Section -->
        <div class="mb-6">
            <svg class="mx-auto h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z" />
            </svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">Membership Card Scanner</h1>
            <p class="text-gray-500 mt-1">Scan a card or create a new one below.</p>
        </div>

        <!-- Scan Button -->
        <button id="scanButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform active:scale-95">
            Scan Membership Card
        </button>

        <!-- Status Messages -->
        <p id="statusMessage" class="mt-4 text-sm text-gray-600 h-5"></p>

        <!-- Membership Card Display (Initially Hidden) -->
        <div id="cardDisplay" class="hidden">
             <div class="mt-6 p-6 bg-gradient-to-br from-indigo-700 to-blue-800 text-white rounded-2xl shadow-2xl text-left fade-in relative">
                <!-- Validation Badge -->
                <span id="validationBadge" class="absolute top-4 right-4 text-xs font-bold px-2.5 py-1 rounded-full"></span>
                <div class="flex justify-between items-start">
                    <h2 class="text-xl font-bold">Club Membership</h2>
                    <span class="bg-yellow-400 text-yellow-900 text-xs font-bold px-2.5 py-1 rounded-full" id="memberLevel"></span>
                </div>
                <div class="mt-8">
                    <p class="text-sm opacity-80">MEMBER NAME</p>
                    <p class="text-2xl font-semibold tracking-wider" id="memberName">-</p>
                </div>
                <div class="mt-4 flex justify-between items-end">
                    <div>
                        <p class="text-sm opacity-80">MEMBER ID</p>
                        <p class="font-mono" id="memberId"> - </p>
                    </div>
                    <div>
                        <p class="text-sm opacity-80 text-right">EXPIRES</p>
                        <p class="font-medium" id="memberExpires"> - </p>
                    </div>
                </div>
            </div>
            <!-- Gemini Welcome Message -->
            <p id="welcomeMessage" class="mt-4 text-gray-700 font-medium h-6"></p>
        </div>

        <!-- Gemini Features Section (Initially Hidden) -->
        <div id="geminiFeatures" class="hidden mt-4 space-y-4">
            <button id="perkButton" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-transform transform active:scale-95">
                âœ¨ Suggest Member Perks
            </button>
            <div id="perkResult" class="p-4 bg-gray-50 rounded-lg text-left text-sm text-gray-700 whitespace-pre-wrap"></div>
            <div id="loadingSpinner" class="hidden mx-auto spinner"></div>
        </div>

        <!-- Admin Panel for Creating Cards -->
        <div class="mt-8 border-t pt-6">
            <h2 class="text-xl font-bold text-gray-800">Admin Panel</h2>
            <div class="mt-4 space-y-4 text-left">
                <div>
                    <label for="newName" class="block text-sm font-medium text-gray-700">Member Name</label>
                    <input type="text" id="newName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Alex Smith">
                </div>
                <div>
                    <label for="newLevel" class="block text-sm font-medium text-gray-700">Membership Level</label>
                    <select id="newLevel" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option>Gold</option>
                        <option>Silver</option>
                        <option>Bronze</option>
                    </select>
                </div>
                 <div>
                    <label for="newExpires" class="block text-sm font-medium text-gray-700">Expiry Date</label>
                    <input type="date" id="newExpires" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="writeButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-transform transform active:scale-95">
                    Generate & Write to NFC Card
                </button>
                <p id="writeStatus" class="mt-2 text-sm text-center h-5"></p>
            </div>
        </div>

    </div>

    <script>
        // --- Element References ---
        const scanButton = document.getElementById('scanButton');
        const statusMessage = document.getElementById('statusMessage');
        const cardDisplay = document.getElementById('cardDisplay');
        const memberName = document.getElementById('memberName');
        const memberId = document.getElementById('memberId');
        const memberLevel = document.getElementById('memberLevel');
        const memberExpires = document.getElementById('memberExpires');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const validationBadge = document.getElementById('validationBadge');
        
        const geminiFeatures = document.getElementById('geminiFeatures');
        const perkButton = document.getElementById('perkButton');
        const perkResult = document.getElementById('perkResult');
        const loadingSpinner = document.getElementById('loadingSpinner');

        const newNameInput = document.getElementById('newName');
        const newLevelInput = document.getElementById('newLevel');
        const newExpiresInput = document.getElementById('newExpires');
        const writeButton = document.getElementById('writeButton');
        const writeStatus = document.getElementById('writeStatus');

        // --- State and Configuration ---
        let currentMemberInfo = null;
        // IMPORTANT: Change this secret key to something unique and private!
        const SECRET_KEY = "your-super-secret-key-that-no-one-knows";

        // --- Utility Functions for Crypto ---

        /**
         * Creates a SHA-256 hash of a string.
         * @param {string} str The string to hash.
         * @returns {Promise<string>} The hex representation of the hash.
         */
        async function createSignature(str) {
            const textBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', textBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        /**
         * Generates a signature for member data.
         * @param {object} data The member data object.
         * @returns {Promise<string>} The calculated signature.
         */
        async function signMemberData(data) {
            // The signature is based on key data fields and the secret key
            const dataString = `${data.memberId}|${data.name}|${data.level}|${data.expires}|${SECRET_KEY}`;
            return await createSignature(dataString);
        }

        // --- Core App Logic ---

        // Check for Web NFC browser support
        if (!('NDEFReader' in window)) {
            statusMessage.textContent = 'Web NFC is not supported on this browser.';
            scanButton.disabled = true;
            writeButton.disabled = true;
            scanButton.classList.add('opacity-50', 'cursor-not-allowed');
            writeButton.classList.add('opacity-50', 'cursor-not-allowed');
        }

        scanButton.addEventListener('click', async () => {
            statusMessage.textContent = 'Tap your NFC card to scan...';
            cardDisplay.classList.add('hidden');
            geminiFeatures.classList.add('hidden');
            perkResult.textContent = '';
            welcomeMessage.textContent = '';

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                ndef.addEventListener('readingerror', () => {
                    statusMessage.textContent = 'Error reading NFC card. Please try again.';
                });

                ndef.addEventListener('reading', async ({ message }) => {
                    statusMessage.textContent = 'Scan successful! Validating...';
                    
                    const record = message.records[0];
                    if (record) {
                        const textDecoder = new TextDecoder(record.encoding);
                        const dataText = textDecoder.decode(record.data);
                        
                        try {
                            const memberInfo = JSON.parse(dataText);
                            currentMemberInfo = memberInfo;
                            await displayMemberInfo(memberInfo);
                            if (memberInfo.signature && (await signMemberData(memberInfo)) === memberInfo.signature) {
                                generateWelcomeMessage(memberInfo.name);
                            }
                        } catch (error) {
                            console.error("Error parsing JSON:", error);
                            statusMessage.textContent = 'Could not parse data from NFC card.';
                        }
                    }
                });

            } catch (error) {
                console.error('NFC Scan Error:', error);
                statusMessage.textContent = `Error: ${error.message}`;
            }
        });

        writeButton.addEventListener('click', async () => {
            const name = newNameInput.value;
            const level = newLevelInput.value;
            const expires = newExpiresInput.value;

            if (!name || !level || !expires) {
                writeStatus.textContent = "Please fill in all fields.";
                return;
            }

            writeStatus.textContent = 'Generating member data...';

            const newMemberData = {
                memberId: `M-${Date.now()}`,
                name: name,
                level: level,
                expires: expires,
            };

            // Sign the data before writing
            newMemberData.signature = await signMemberData(newMemberData);
            
            writeStatus.textContent = 'Tap a blank card to write...';

            try {
                const ndef = new NDEFReader();
                await ndef.write({
                    records: [{ recordType: "text", data: JSON.stringify(newMemberData) }]
                });
                writeStatus.textContent = 'Successfully wrote to card!';
                // Clear fields after successful write
                newNameInput.value = '';
                newExpiresInput.value = '';

            } catch (error) {
                console.error("NFC Write Error:", error);
                writeStatus.textContent = 'Failed to write. Tap card and try again.';
            }
        });


        async function displayMemberInfo(info) {
            // Validate the signature
            const expectedSignature = await signMemberData(info);
            const isValid = info.signature && expectedSignature === info.signature;
            
            validationBadge.textContent = isValid ? 'VALID' : 'INVALID';
            validationBadge.className = `absolute top-4 right-4 text-xs font-bold px-2.5 py-1 rounded-full ${isValid ? 'bg-green-400 text-green-900' : 'bg-red-400 text-red-900'}`;
            
            // Populate card details
            memberName.textContent = info.name || 'N/A';
            memberId.textContent = info.memberId || 'N/A';
            memberLevel.textContent = info.level || 'Standard';
            memberExpires.textContent = info.expires || 'N/A';

            cardDisplay.classList.remove('hidden');
            
            // Only show Gemini features for valid cards
            if (isValid) {
                geminiFeatures.classList.remove('hidden');
            } else {
                 geminiFeatures.classList.add('hidden');
                 welcomeMessage.textContent = 'This card is not valid.';
            }
        }
        
        perkButton.addEventListener('click', () => {
            if (currentMemberInfo) {
                generatePerkIdeas(currentMemberInfo.name, currentMemberInfo.level);
            }
        });

        // --- Gemini API Integration ---

        async function callGemini(prompt) {
            const apiKey = ""; // Leave empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            let retries = 3, delay = 1000;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            return result.candidates[0].content.parts[0].text;
                        } else { throw new Error("Invalid API response"); }
                    } else { throw new Error(`API request failed with status ${response.status}`); }
                } catch (error) {
                    console.error(`Attempt failed: ${error.message}. Retrying...`);
                    retries--;
                    if (retries === 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function generateWelcomeMessage(name) {
            welcomeMessage.textContent = 'Generating a special welcome...';
            try {
                const prompt = `Generate a short, cheerful, one-sentence welcome message for a returning club member named ${name}.`;
                welcomeMessage.textContent = await callGemini(prompt);
            } catch (error) {
                console.error("Welcome message failed:", error);
                welcomeMessage.textContent = `Welcome back, ${name}!`;
            }
        }

        async function generatePerkIdeas(name, level) {
            perkResult.textContent = '';
            loadingSpinner.classList.remove('hidden');
            perkButton.disabled = true;
            try {
                const prompt = `Generate 3 fun and engaging perk suggestions for a '${level}' level member named ${name}. Format as a bulleted list.`;
                perkResult.textContent = await callGemini(prompt);
            } catch (error) {
                console.error("Perk suggestion failed:", error);
                perkResult.textContent = "Could not generate perk ideas right now.";
            } finally {
                loadingSpinner.classList.add('hidden');
                perkButton.disabled = false;
            }
        }

    </script>
</body>
</html>
